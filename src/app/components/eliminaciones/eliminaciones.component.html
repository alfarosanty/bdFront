<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


<div class="general-container">

<div class="superior-container">
<div class="selector-container">
    <h2>TALLERES</h2>

    <!-- Menú desplegable de clientes -->
    <div class="dropdown">
      <h6>Seleccionar Taller:</h6>
      <mat-form-field appearance="fill">
        <mat-label>Seleccione un Taller</mat-label>
        <mat-select 
          [(ngModel)]="currentTaller" 
          (selectionChange)="seleccionarTaller()"
          [disabled]="!tipoEliminacion">
          <mat-option [value]="null">Seleccione un Taller</mat-option>
          <mat-option *ngFor="let taller of talleres" [value]="taller">
            {{ taller.razonSocial }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <h6>Tipo de eliminación</h6>
      <mat-form-field appearance="fill">
        <mat-label>Tipo de eliminación</mat-label>
        <mat-select [(ngModel)]="tipoEliminacion"
        (selectionChange)="buscarOrdenXTaller()">
          <mat-option [value]="null">Seleccione tipo</mat-option>
          <mat-option value="PedidoProduccion">PEDIDO PRODUCCIÓN</mat-option>
          <mat-option value="Ingreso">INGRESO</mat-option>
        </mat-select>
      </mat-form-field>
      
      
      
                    
    </div>

</div>

</div>

<div class="inferior-container">
    <h3>Datos de los pedido producción</h3>

    <div class="datos-comprobante">


        <div>
          <mat-form-field class="fecha-field">
            <mat-label>Ingrese itervalo de fechas</mat-label>
            <mat-date-range-input [rangePicker]="rangePicker">
              <input matStartDate [(ngModel)]="fechaInicio" name="fechaInicio" />
              <input matEndDate [(ngModel)]="fechaFin" name="fechaFin" />
            </mat-date-range-input>
            <mat-hint>DD/MM/YYYY – DD/MM/YYYY</mat-hint>
            <mat-datepicker-toggle matIconSuffix [for]="rangePicker"></mat-datepicker-toggle>
            <mat-date-range-picker #rangePicker>
              <mat-date-range-picker-actions>
                <button mat-button matDateRangePickerCancel>Cancel</button>
                <button mat-raised-button
                (click)="aplicarFiltros(tipoEliminacion === 'PedidoProduccion' ? pedidosProduccionXTaller : ingresosXTaller)" matDateRangePickerApply>Apply</button>
                      </mat-date-range-picker-actions>
            </mat-date-range-picker>
          </mat-form-field>     
        </div>

            <div>
              <mat-form-field appearance="fill" *ngIf="tipoEliminacion == 'PedidoProduccion'">
                <mat-label>Filtro estado</mat-label>
                <mat-select [(ngModel)]="filtroEstadoPedido"
                            name="filtroEstadoPedido"
                            (selectionChange)="aplicarFiltros(pedidosProduccionXTaller)">
                  
                  <mat-option [value]="null">TODOS</mat-option>
                  
                  <mat-option *ngFor="let estado of estadosPedidoProduccion" [value]="estado">
                    {{ estado.descripcion }}
                  </mat-option>
                  
                </mat-select>
              </mat-form-field>
              
              
              
            </div>
        

    </div>
</div>

<h3>Grilla de Información</h3>
<table mat-table [dataSource]="dataSource" multiTemplateDataRows class="mat-elevation-z8">

    <!-- Columnas dinámicas -->
    <ng-container matColumnDef="{{ column }}" *ngFor="let column of columnsToDisplay">
      <th mat-header-cell *matHeaderCellDef>{{ column }}</th>
      <td mat-cell *matCellDef="let element">
        <ng-container [ngSwitch]="column">
  
        <!-- ID - FECHA -->
        <ng-container *ngSwitchCase="'Pedido'">
          {{ element.id }} - {{ formatearFecha(element.fecha) }} -
          {{ presupuestosMap.get(element.idPresupuesto || 0)?.cliente?.razonSocial || 'Stock' }}
        </ng-container>

        <ng-container *ngSwitchCase="'Ingreso'">
          {{ element.id }} - {{ formatearFecha(element.fecha) }} -
          {{ element.taller?.razonSocial || 'Proveedor desconocido' }}
        </ng-container>

  
          <!-- SUMATORIA CANTIDADES -->
          <ng-container *ngSwitchCase="'Cantidad Total'">
            {{ sumatoriaCantidadTotal(element) }}
          </ng-container>
  
          <!-- SUMATORIA CANTIDADES PENDIENTES 
          <ng-container *ngSwitchCase="'Cantidad Pendiente'">
            {{ sumatoriaCantidadPendienteTotal(element) }}
          </ng-container>
  -->
          <!-- ESTADO -->
          <ng-container *ngSwitchCase="'Estado'">
            {{ mostrarEstado(element) }}
          </ng-container>
  
          <!-- COLUMNA Seleccionar -->
          <ng-container *ngSwitchCase="'Seleccionar'">
            <mat-checkbox [(ngModel)]="element.seleccionadoEliminar"
                          (click)="$event.stopPropagation(); agregarClienteAMapa(element)">
            </mat-checkbox>
          </ng-container>
  
          <!-- DEFAULT -->
          <ng-container *ngSwitchDefault>
            {{ element[column] }}
          </ng-container>
  
        </ng-container>
      </td>
    </ng-container>
  
    <!-- Fila expandible con artículos -->
    <ng-container matColumnDef="expandedDetail">
      <td mat-cell *matCellDef="let element" [attr.colspan]="columnsToDisplay.length">
        <div class="example-element-detail" [@detailExpand]="element === expandedElement ? 'expanded' : 'collapsed'">
          <table mat-table [dataSource]="element.articulos" class="mat-elevation-z1">
  
            <!-- COLUMNA ARTÍCULO -->
            <ng-container matColumnDef="codigoArticulo">
              <th mat-header-cell *matHeaderCellDef>Artículo</th>
              <td mat-cell *matCellDef="let articulo">
                {{ articulo.articulo.codigo }} {{ articulo.articulo.color.descripcion }}
                <span class="color-circle"
                      [ngStyle]="{ 'background-color': articulo.articulo.color?.colorHexa || '#000' }">
                </span>
              </td>
            </ng-container>
  
            <!-- COLUMNA DESCRIPCIÓN -->
            <ng-container matColumnDef="descripcionArticulo">
              <th mat-header-cell *matHeaderCellDef>Descripción</th>
              <td mat-cell *matCellDef="let articulo">
                {{ articulo.articulo.descripcion }}
              </td>
            </ng-container>
  
            <!-- COLUMNA CANTIDAD -->
            <ng-container matColumnDef="cantidad">
              <th mat-header-cell *matHeaderCellDef>Cantidad</th>
              <td mat-cell *matCellDef="let articulo">
                {{ articulo.cantidad }}
              </td>
            </ng-container>
  
            <!-- COLUMNA CANTIDAD PENDIENTE 
            <ng-container matColumnDef="cantidadPendiente">
              <th mat-header-cell *matHeaderCellDef>Cantidad Pendiente</th>
              <td mat-cell *matCellDef="let articulo">
                {{ articulo.cantidadPendiente }}
              </td>
            </ng-container>
  -->
            <!-- FILAS DE ARTÍCULOS -->
            <tr mat-header-row *matHeaderRowDef="['codigoArticulo', 'descripcionArticulo', 'cantidad']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['codigoArticulo', 'descripcionArticulo', 'cantidad']"></tr>
  
          </table>
        </div>
      </td>
    </ng-container>
  
    <!-- Filas principales -->
    <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
    <tr mat-row *matRowDef="let element; columns: columnsToDisplay"
        class="example-element-row"
        [class.example-expanded-row]="expandedElement === element"
        (click)="expandedElement = expandedElement === element ? null : element">
    </tr>
  
    <!-- Fila expandida -->
    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
  
  </table>
  
  
  

<div class="button-container botones-separados">
  
  <div class="boton-seleccionarPresupuesto">
    <button mat-raised-button (click)="mostrarOpciones()" class="boton-opcion" color="primary">
      Confirmar
    </button>
  </div>

</div>


<div class="backdrop" *ngIf="mostrarConfirmacionPDF">
  <div class="mensaje-confirmacion animado">
    <span class="icono">✅</span>
    <span>
      ¡Se eliminaron 
      {{ tipoEliminacion === 'PedidoProduccion' ? cantidadPedidosABorrar() : cantidadIngresosABorrar() }} 
      {{ tipoEliminacion === 'PedidoProduccion' ? 'Pedidos producción' : 'Ingresos' }} de id: 
      {{ tipoEliminacion === 'PedidoProduccion' ? pedidosABorrarIdsString() : ingresosABorrarIdsString() }}
      </span>
  </div>
</div>



